<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>北海道冬旅 | Hokkaido Winter Trip</title>
    <meta name="apple-mobile-web-app-title" content="北海道冬旅">
    <meta name="format-detection" content="telephone=no">
    <!-- Android Chrome 設定 -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f0f9ff">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Noto Sans TC & Lato -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, addDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Firebase & Auth State ---
        let db;
        let auth;
        let userId = null;
        let initialDataLoaded = { expenses: false, packing: false, memos: false };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hokkaido-2026';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // --- Toast Logic ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const item = document.createElement('div');
            item.className = 'toast-item';
            item.textContent = message;
            if (type === 'error') item.style.backgroundColor = '#ef4444';
            container.prepend(item);
            setTimeout(() => item.classList.add('show'), 10);
            setTimeout(() => { item.classList.remove('show'); setTimeout(() => item.remove(), 300); }, 3000);
        }

        // --- Core Functions Export to Window ---
        window.openMap = (q) => { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank'); };
        
        window.toggleDrawer = (show) => {
            const d = document.getElementById('expense-drawer');
            d.style.display = show ? "block" : "none";
            if (!show) {
                document.getElementById('exp-name').value = '';
                document.getElementById('exp-amt').value = '';
                window.tmpImg = null;
                document.getElementById('exp-img').value = '';
                document.getElementById('img-check').classList.add('hidden');
                document.getElementById('type-cash').checked = true;
                // Reset visual style
                document.getElementById('label-cash').style.cssText = `background-color: #ffffff; border: 1px solid #3b82f6; color: #3b82f6;`;
                document.getElementById('label-credit').style.cssText = '';
            }
        };
        
        window.winOpen = (u) => { const w=window.open(""); w.document.write(`<img src="${u}" style="width:100%">`); };

        // --- Expense Logic ---
        window.saveExp = async () => {
            if (!db || !userId) { showToast('錯誤：未連線至雲端。', 'error'); return; }
            const name = document.getElementById('exp-name').value.trim();
            const amount = parseInt(document.getElementById('exp-amt').value);
            const type = document.querySelector('input[name="payment-type"]:checked').value;

            if(!name || isNaN(amount) || amount <= 0) { showToast('請輸入有效內容。', 'error'); return; }
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/expenses`), {
                    name, amount, type, img: window.tmpImg || null, timestamp: Date.now()
                });
                showToast('已儲存！');
                window.toggleDrawer(false);
            } catch (e) { console.error(e); showToast('儲存失敗', 'error'); }
        };

        window.delExp = async (id) => {
             if(confirm('確定刪除此記錄？')) {
                 try { await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/expenses`, id)); showToast('已刪除'); }
                 catch(e) { console.error(e); }
             }
        };

        window.clearExpHistory = async () => {
             if(confirm('確定清除所有記錄？')) {
                 const q = query(collection(db, `artifacts/${appId}/users/${userId}/expenses`));
                 const snapshot = await getDocs(q);
                 snapshot.docs.forEach(d => deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/expenses`, d.id)));
                 showToast('已清除');
             }
        };

        // --- List Logic ---
        window.addPack = async () => {
            const text = document.getElementById('new-pack').value.trim();
            if(text && db) {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/packing`), { text, checked: false, timestamp: Date.now() });
                document.getElementById('new-pack').value = '';
            }
        };
        window.togPack = async (id, state) => { if(db) await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/packing`, id), { checked: !state }); };
        window.delPack = async (id) => { if(db) await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/packing`, id)); };

        window.addMemo = async () => {
            const text = document.getElementById('new-memo').value.trim();
            if(text && db) {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/memos`), { text, timestamp: Date.now() });
                document.getElementById('new-memo').value = '';
                showToast('備忘已新增');
            }
        };
        window.delMemo = async (id) => { if(db && confirm('刪除備忘？')) await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/memos`, id)); };

        // --- Rendering ---
        function renderExps(exps) {
            const el = document.getElementById('expense-list');
            el.innerHTML = '';
            const r = parseFloat(document.getElementById('exchange-rate').value) || 0.22;
            let cash = 0, credit = 0;
            
            exps.sort((a,b) => b.timestamp - a.timestamp);
            if(exps.length === 0) el.innerHTML = '<p class="text-center text-gray-400 py-4">尚無記錄</p>';

            exps.forEach(e => {
                const amt = e.amount || 0;
                if(e.type === 'cash') cash += amt; else credit += amt;
                const icon = e.type === 'cash' ? '<span class="text-xs bg-green-100 text-green-700 px-1 rounded">現金</span>' : '<span class="text-xs bg-blue-100 text-blue-700 px-1 rounded">刷卡</span>';
                
                el.insertAdjacentHTML('beforeend', `
                    <div class="card p-3 flex justify-between items-center shadow-sm">
                        <div class="flex gap-3 items-center flex-1 min-w-0">
                            ${e.img ? `<div class="w-10 h-10 rounded-lg bg-cover bg-center" style="background-image:url('${e.img}')" onclick="winOpen('${e.img}')"></div>` : `<div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400"><i class="fas fa-receipt"></i></div>`}
                            <div class="truncate">
                                <div class="font-bold text-sm truncate">${e.name}</div>
                                <div class="text-xs text-gray-400">${new Date(e.timestamp).toLocaleDateString()} ${icon}</div>
                            </div>
                        </div>
                        <div class="text-right ml-2">
                            <div class="font-bold text-sm">¥${amt.toLocaleString()}</div>
                            <div class="text-xs text-gray-500">TWD$${Math.floor(amt*r).toLocaleString()}</div>
                            <button onclick="delExp('${e.id}')" class="text-red-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `);
            });

            // Summary
            const total = cash + credit;
            document.getElementById('expense-list').insertAdjacentHTML('afterbegin', `
                <div class="card p-4 bg-sky-500 text-white mb-4 shadow-lg">
                    <div class="flex justify-between items-center border-b border-white/30 pb-2 mb-2">
                        <span class="text-sm">總支出</span>
                        <span class="text-2xl font-bold font-num">¥${total.toLocaleString()}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div><i class="fas fa-money-bill-wave mr-1"></i> 現金: ¥${cash.toLocaleString()}</div>
                        <div><i class="fas fa-credit-card mr-1"></i> 刷卡: ¥${credit.toLocaleString()}</div>
                    </div>
                </div>
            `);
        }

        function renderPack(list) {
            const c = document.getElementById('packing-container'); c.innerHTML = '';
            if(list.length===0) c.innerHTML = '<p class="text-center text-gray-400 py-4">清單是空的</p>';
            list.sort((a,b) => a.text.localeCompare(b.text));
            list.forEach(i => {
                c.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center justify-between p-3 border-b border-gray-100" onclick="togPack('${i.id}', ${i.checked})">
                        <div class="flex items-center gap-3">
                            <div class="w-5 h-5 rounded-full border ${i.checked?'bg-sky-500 border-sky-500':'border-gray-300'} flex items-center justify-center text-white text-xs">${i.checked?'✓':''}</div>
                            <span class="${i.checked?'text-gray-400 line-through':''}">${i.text}</span>
                        </div>
                        <button onclick="event.stopPropagation();delPack('${i.id}')" class="text-gray-300"><i class="fas fa-trash"></i></button>
                    </div>
                `);
            });
        }

        function renderMemo(list) {
            const c = document.getElementById('memo-container'); c.innerHTML = '';
            if(list.length===0) c.innerHTML = '<p class="text-center text-gray-400 py-4">尚無備忘</p>';
            list.sort((a,b) => b.timestamp - a.timestamp);
            list.forEach(m => {
                c.insertAdjacentHTML('beforeend', `
                    <div class="bg-white p-3 rounded shadow-sm border-l-4 border-sky-400 relative mb-2">
                        <p class="whitespace-pre-wrap text-sm text-gray-700">${m.text}</p>
                        <button onclick="delMemo('${m.id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fas fa-times"></i></button>
                    </div>
                `);
            });
        }

        // --- Init ---
        window.onload = function() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Start Listeners
                        onSnapshot(query(collection(db, `artifacts/${appId}/users/${userId}/expenses`)), (s) => renderExps(s.docs.map(d=>({id:d.id,...d.data()}))));
                        onSnapshot(query(collection(db, `artifacts/${appId}/users/${userId}/packing`)), (s) => renderPack(s.docs.map(d=>({id:d.id,...d.data()}))));
                        onSnapshot(query(collection(db, `artifacts/${appId}/users/${userId}/memos`)), (s) => renderMemo(s.docs.map(d=>({id:d.id,...d.data()}))));
                    } else {
                        signInAnonymously(auth).catch(console.error);
                    }
                });
            } catch(e) { console.error("Firebase Init Error", e); }

            // Other UI Init
            document.getElementById('weather-day-1').innerHTML = getWeatherBarHtml(0);
            document.getElementById('weather-day-2').innerHTML = getWeatherBarHtml(1);
            document.getElementById('weather-day-3').innerHTML = getWeatherBarHtml(2);
            document.getElementById('weather-day-4').innerHTML = getWeatherBarHtml(3);
            document.getElementById('weather-day-5').innerHTML = getWeatherBarHtml(4);
            document.getElementById('weather-day-6').innerHTML = getWeatherBarHtml(5);
            
            renderPoiQuickLinks();
            getGeolocation(); // For top banner

            // Radio Button Style Logic
            document.querySelectorAll('input[name="payment-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('label-cash').style.cssText = '';
                    document.getElementById('label-credit').style.cssText = '';
                    document.getElementById(`label-${e.target.value}`).style.cssText = `background-color: #ffffff; border: 1px solid #3b82f6; color: #3b82f6;`;
                });
            });

            // Initial Nav
            nav('plan');
            switchPlanPage('overview');
            setTimeout(() => document.getElementById('splash-screen').style.display='none', 800);
        };
    </script>

    <style>
        /* Base Styles */
        body { background-color: #f0f9ff; color: #334155; font-family: 'Noto Sans TC', sans-serif; padding-bottom: 90px; }
        .card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e0f2fe; }
        .card:active { transform: scale(0.99); transition: 0.1s; }
        
        /* Time Highlight */
        .time-highlight { font-weight: 700; color: #0ea5e9; background-color: #e0f2fe; padding: 4px 8px; border-radius: 6px; font-family: 'Lato'; min-width: 50px; text-align: center; display: inline-block;}

        /* Weather Bar */
        .weather-bar { background: linear-gradient(135deg, #38bdf8, #0ea5e9); color: white; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.2); cursor: pointer; }
        
        /* Sub Nav */
        .sub-nav-container { overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; padding-bottom: 5px; }
        .sub-nav-container::-webkit-scrollbar { display: none; }
        .sub-nav-item { display: inline-block; padding: 10px 16px; font-size: 14px; font-weight: 500; color: #64748b; transition: all 0.2s; border-bottom: 2px solid transparent; }
        .sub-nav-item.active { color: #0ea5e9; border-bottom-color: #0ea5e9; font-weight: 700; }

        /* Navigation */
        .nav-item { color: #94a3b8; transition: color 0.2s; }
        .nav-item.active { color: #0ea5e9; }
        
        /* Sections */
        .tab-content, .plan-page { display: none; }
        .active { display: block; }
        
        /* Splash */
        #splash-screen { position: fixed; inset: 0; background: #e0f2fe; z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .fade-out { opacity: 0; pointer-events: none; }
        
        /* Toast */
        #toast-container { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 80%; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
        .toast-item { background: #10b981; color: white; padding: 10px 20px; border-radius: 50px; text-align: center; opacity: 0; transform: translateY(-10px); transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px; }
        .toast-item.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

    <!-- Toast -->
    <div id="toast-container"></div>

    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="mb-6 animate-bounce">
            <!-- Shima Enaga SVG -->
            <svg width="140" height="140" viewBox="0 0 512 512">
                <circle cx="256" cy="270" r="170" fill="#ffffff" />
                <circle cx="190" cy="240" r="18" fill="#1e293b"/>
                <circle cx="322" cy="240" r="18" fill="#1e293b"/>
                <path d="M246 260 L266 260 L256 280 Z" fill="#f59e0b"/>
                <ellipse cx="170" cy="290" rx="25" ry="15" fill="#fecaca" opacity="0.5"/>
                <ellipse cx="342" cy="290" rx="25" ry="15" fill="#fecaca" opacity="0.5"/>
                <path d="M256 440 Q280 520 200 520" stroke="#334155" stroke-width="20" fill="none" stroke-linecap="round"/>
                <path d="M100 300 Q80 350 120 380" stroke="#cbd5e1" stroke-width="10" fill="none" stroke-linecap="round"/>
                <path d="M412 300 Q432 350 392 380" stroke="#cbd5e1" stroke-width="10" fill="none" stroke-linecap="round"/>
            </svg>
        </div>
        <h1 class="text-2xl font-bold text-slate-700 tracking-widest">北海道冬旅</h1>
        <p class="text-xs text-sky-500 mt-2 font-mono">2026 Winter Trip</p>
    </div>

    <!-- Header -->
    <header class="fixed top-0 w-full bg-white/90 backdrop-blur-md z-40 px-4 pb-3 pt-safe border-b border-slate-100 flex justify-between items-end h-[calc(60px+env(safe-area-inset-top))]">
        <div>
            <h1 class="text-xl font-bold text-slate-800">北海道冬旅</h1>
            <p class="text-[10px] text-slate-400 tracking-wider">Hokkaido 2026</p>
        </div>
        <span class="text-[10px] bg-sky-100 text-sky-600 px-3 py-1 rounded-full font-bold">Mar 19-24</span>
    </header>

    <main class="mt-[calc(70px+env(safe-area-inset-top))] px-4" id="app">
        
        <!-- Current Weather -->
        <div id="current-weather-display" class="weather-bar p-4 rounded-2xl mb-6 shadow-md hidden flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-location-arrow text-2xl mr-3 opacity-90"></i>
                <div>
                    <p class="text-xs opacity-90" id="current-location">定位中...</p>
                    <p class="text-xl font-bold" id="current-temp">--°C</p>
                </div>
            </div>
            <div class="text-right">
                 <p class="text-xs opacity-90" id="weather-desc">即時天氣</p>
                 <p class="text-lg mt-1" id="weather-icon">☁️</p>
            </div>
        </div>

        <!-- SECTION: PLAN -->
        <div id="section-plan" class="tab-content active">
            <!-- Sub Nav -->
            <div class="sticky top-[calc(60px+env(safe-area-inset-top))] z-30 bg-white/95 backdrop-blur-sm -mx-4 px-4 border-b border-slate-100 sub-nav-container">
                <div class="inline-flex">
                    <button id="subnav-overview" class="sub-nav-item active" onclick="switchPlanPage('overview')">總覽</button>
                    <button id="subnav-day1" class="sub-nav-item" onclick="switchPlanPage('day1')">Day 1</button>
                    <button id="subnav-day2" class="sub-nav-item" onclick="switchPlanPage('day2')">Day 2</button>
                    <button id="subnav-day3" class="sub-nav-item" onclick="switchPlanPage('day3')">Day 3</button>
                    <button id="subnav-day4" class="sub-nav-item" onclick="switchPlanPage('day4')">Day 4</button>
                    <button id="subnav-day5" class="sub-nav-item" onclick="switchPlanPage('day5')">Day 5</button>
                    <button id="subnav-day6" class="sub-nav-item" onclick="switchPlanPage('day6')">Day 6</button>
                </div>
            </div>

            <!-- PAGE: OVERVIEW -->
            <div id="plan-page-overview" class="plan-page active pt-6">
                <div class="card p-6 text-center bg-gradient-to-br from-white to-sky-50 border-none shadow-xl mb-6">
                    <div class="mx-auto mb-4 w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm text-3xl">❄️</div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-1">北海道 6 日周遊</h2>
                    <p class="text-sm text-slate-500">函館 ➔ 洞爺 ➔ 札幌 ➔ 小樽</p>
                </div>

                <div class="mb-6">
                    <h3 class="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">航班 Flights</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="card p-4 border-l-4 border-sky-400">
                            <div class="text-xs font-bold text-sky-500 mb-1">去程 (虎航)</div>
                            <div class="font-bold text-lg text-slate-800">06:45</div>
                            <div class="text-xs text-slate-400 mb-2">TPE 台北</div>
                            <div class="font-bold text-lg text-slate-800">11:10</div>
                            <div class="text-xs text-slate-400">HKD 函館</div>
                            <div class="mt-2 text-[10px] bg-slate-100 inline-block px-2 rounded text-slate-500">TTW236</div>
                        </div>
                        <div class="card p-4 border-l-4 border-sky-400">
                            <div class="text-xs font-bold text-sky-500 mb-1">回程 (越捷)</div>
                            <div class="font-bold text-lg text-slate-800">09:30</div>
                            <div class="text-xs text-slate-400 mb-2">CTS 新千歲</div>
                            <div class="font-bold text-lg text-slate-800">13:30</div>
                            <div class="text-xs text-slate-400">TPE 台北</div>
                            <div class="mt-2 text-[10px] bg-slate-100 inline-block px-2 rounded text-slate-500">TVJ571</div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">住宿 Hotels</h3>
                    <div class="space-y-3">
                        <div class="card p-4 flex gap-4 items-center" onclick="openMap('JR Inn Hakodate')">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-bed"></i></div>
                            <div>
                                <div class="font-bold text-slate-700">JR INN Hakodate</div>
                                <div class="text-xs text-slate-400">Day 1 (函館站旁)</div>
                            </div>
                        </div>
                        <div class="card p-4 flex gap-4 items-center" onclick="openMap('WE Hotel Toya')">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-hot-tub"></i></div>
                            <div>
                                <div class="font-bold text-slate-700">WE Hotel Toya</div>
                                <div class="text-xs text-slate-400">Day 2 (隈研吾設計)</div>
                            </div>
                        </div>
                        <div class="card p-4 flex gap-4 items-center" onclick="openMap('Keio Prelia Hotel Sapporo')">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-city"></i></div>
                            <div>
                                <div class="font-bold text-slate-700">Keio Prelia Sapporo</div>
                                <div class="text-xs text-slate-400">Day 3-5 (札幌北口)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: DAY 1 -->
            <div id="plan-page-day1" class="plan-page pt-6">
                <div id="weather-day-1"></div>
                <div class="space-y-4">
                    <!-- Item -->
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">11:30</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">抵達函館機場 (HKD)</h4>
                            <p class="text-sm text-slate-500 mt-1">入境、提領行李。</p>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">13:00</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">JR Inn 辦理入住/寄放</h4>
                            <p class="text-sm text-slate-500 mt-1">飯店位於函館車站旁。</p>
                            <button onclick="openMap('JR Inn Hakodate')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full"><i class="fas fa-location-arrow mr-1"></i>導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4 border-l-4 border-red-400">
                        <div class="time-highlight">13:23</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">幸運小丑漢堡 (午餐)</h4>
                            <p class="text-sm text-slate-500 mt-1">函館名物！推薦中華炸雞漢堡。</p>
                            <button onclick="openMap('幸運小丑漢堡 函館站前店')" class="mt-2 text-xs bg-red-50 text-red-600 px-3 py-1 rounded-full"><i class="fas fa-utensils mr-1"></i>導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">14:51</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">五稜郭塔</h4>
                            <p class="text-sm text-slate-500 mt-1">俯瞰星形要塞，歷史巡禮。</p>
                            <button onclick="openMap('五稜郭塔')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full"><i class="fas fa-location-arrow mr-1"></i>導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">16:31</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">八幡坂</h4>
                            <p class="text-sm text-slate-500 mt-1">直通大海的美麗坡道，拍照熱點。</p>
                            <button onclick="openMap('八幡坂')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full"><i class="fas fa-camera mr-1"></i>導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">17:05</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">函館山百萬夜景</h4>
                            <p class="text-sm text-slate-500 mt-1">搭乘纜車上山，世界三大夜景。</p>
                            <button onclick="openMap('函館山纜車')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full"><i class="fas fa-star mr-1"></i>導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">19:01</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">返回 JR Inn 休息</h4>
                            <p class="text-sm text-slate-500 mt-1">結束第一天行程。</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: DAY 2 -->
            <div id="plan-page-day2" class="plan-page pt-6">
                <div id="weather-day-2"></div>
                <div class="space-y-4">
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">08:24</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">金森紅磚倉庫</h4>
                            <p class="text-sm text-slate-500 mt-1">港邊散步，異國風情倉庫群。</p>
                            <button onclick="openMap('金森紅磚倉庫')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">09:25</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">星巴克 函館濱海店</h4>
                            <p class="text-sm text-slate-500 mt-1">海景咖啡時光。</p>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4 bg-sky-50 border-l-4 border-sky-500">
                        <div class="time-highlight bg-sky-600 text-white">09:00</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-sky-900">租車取車 (預計)</h4>
                            <p class="text-sm text-sky-700 mt-1">依照租車公司指引前往取車，開始自駕。</p>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">12:53</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">昭和新山熊牧場</h4>
                            <p class="text-sm text-slate-500 mt-1">餵食可愛棕熊。</p>
                            <button onclick="openMap('昭和新山熊牧場')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">13:54</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">洞爺湖有珠山纜車</h4>
                            <p class="text-sm text-slate-500 mt-1">眺望火山與湖景。</p>
                            <button onclick="openMap('有珠山纜車')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">17:13</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">洞爺湖展望台</h4>
                            <p class="text-sm text-slate-500 mt-1">全景拍攝點。</p>
                            <button onclick="openMap('洞爺湖展望台')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">17:53</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">入住 WE Hotel Toya</h4>
                            <p class="text-sm text-slate-500 mt-1">隈研吾設計的溫泉飯店。</p>
                            <button onclick="openMap('WE Hotel Toya')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: DAY 3 -->
            <div id="plan-page-day3" class="plan-page pt-6">
                <div id="weather-day-3"></div>
                <div class="space-y-4">
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">09:33</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">登別地獄谷</h4>
                            <p class="text-sm text-slate-500 mt-1">硫磺煙霧繚繞的火山地形。</p>
                            <button onclick="openMap('登別地獄谷')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">11:45</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">尼克斯海洋公園</h4>
                            <p class="text-sm text-slate-500 mt-1">必看企鵝遊行。</p>
                            <button onclick="openMap('尼克斯海洋公園')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">15:08</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">白色戀人公園</h4>
                            <p class="text-sm text-slate-500 mt-1">歐風庭園與甜點工廠。</p>
                            <button onclick="openMap('白色戀人公園')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">17:01</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">Stellar Place 晚餐/購物</h4>
                            <p class="text-sm text-slate-500 mt-1">札幌車站直結商場。</p>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">20:05</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">入住 札幌京王普雷利亞</h4>
                            <p class="text-sm text-slate-500 mt-1">札幌北口，設有大浴場。</p>
                            <button onclick="openMap('京王普雷利亞飯店札幌')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: DAY 4 -->
            <div id="plan-page-day4" class="plan-page pt-6">
                <div id="weather-day-4"></div>
                <div class="space-y-4">
                    <div class="card p-4 flex gap-4 bg-yellow-50">
                        <div class="time-highlight bg-yellow-500 text-white">08:00</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">長途自駕日 (往旭川)</h4>
                            <p class="text-sm text-slate-500 mt-1">前往道北，車程較長請注意休息。</p>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">10:18</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">旭川神社</h4>
                            <p class="text-sm text-slate-500 mt-1">參拜祈福。</p>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">10:45</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">旭山動物園</h4>
                            <p class="text-sm text-slate-500 mt-1">必看企鵝散步(視雪量)、北極熊。</p>
                            <button onclick="openMap('旭山動物園')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">13:57</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">白鬚瀑布</h4>
                            <p class="text-sm text-slate-500 mt-1">美瑛著名景觀。</p>
                            <button onclick="openMap('白鬚瀑布')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">14:24</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">白金青池</h4>
                            <p class="text-sm text-slate-500 mt-1">夢幻藍色池水與枯木。</p>
                            <button onclick="openMap('白金青池')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">18:09</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">狸小路商店街</h4>
                            <p class="text-sm text-slate-500 mt-1">返回札幌，晚餐與藥妝採買。</p>
                            <button onclick="openMap('狸小路商店街')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4 border-l-4 border-red-500 bg-red-50">
                        <div class="time-highlight bg-red-500 text-white">19:00</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-red-900">札幌還車</h4>
                            <p class="text-sm text-red-700 mt-1">請務必在 19:00 前完成還車手續。</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: DAY 5 -->
            <div id="plan-page-day5" class="plan-page pt-6">
                <div id="weather-day-5"></div>
                <div class="space-y-4">
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">09:13</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">抵達小樽站</h4>
                            <p class="text-sm text-slate-500 mt-1">搭乘 JR 抵達。</p>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">10:26</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">小樽運河</h4>
                            <p class="text-sm text-slate-500 mt-1">經典拍照景點，感受懷舊氛圍。</p>
                            <button onclick="openMap('小樽運河')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">12:58</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">小樽住吉神社</h4>
                            <p class="text-sm text-slate-500 mt-1">小樽總鎮守。</p>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">15:01</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">北海道神宮</h4>
                            <p class="text-sm text-slate-500 mt-1">返回札幌參拜，環境清幽。</p>
                            <button onclick="openMap('北海道神宮')" class="mt-2 text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4 border-l-4 border-red-400">
                        <div class="time-highlight">17:38</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">拉麵 札幌一粒庵</h4>
                            <p class="text-sm text-slate-500 mt-1">米其林推薦，必吃味噌拉麵。</p>
                            <button onclick="openMap('拉麵 札幌一粒庵')" class="mt-2 text-xs bg-red-50 text-red-600 px-3 py-1 rounded-full">導航</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: DAY 6 -->
            <div id="plan-page-day6" class="plan-page pt-6">
                <div id="weather-day-6"></div>
                <div class="space-y-4">
                    <div class="card p-4 flex gap-4 bg-red-50 border-l-4 border-red-500">
                        <div class="time-highlight bg-red-500 text-white">06:18</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-red-900">飯店出發 → 機場</h4>
                            <p class="text-sm text-red-700 mt-1">前往新千歲機場，準備回程。</p>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">07:31</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">抵達新千歲機場</h4>
                            <p class="text-sm text-slate-500 mt-1">最後購物 (伴手禮/甜點)，享用早餐。</p>
                        </div>
                    </div>
                    <div class="card p-4 flex gap-4">
                        <div class="time-highlight">09:30</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">✈️ 起飛返台</h4>
                            <p class="text-sm text-slate-500 mt-1">TVJ571 飛往桃園。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: GUIDE -->
        <div id="section-guide" class="tab-content">
            <h2 class="text-xl font-bold text-slate-800 mb-4 border-l-4 border-slate-400 pl-3">景點快速導航</h2>
            <div class="grid grid-cols-2 gap-3" id="poi-quick-links"></div>
        </div>

        <!-- SECTION: UTIL -->
        <div id="section-util" class="tab-content">
            <h2 class="text-xl font-bold text-slate-800 mb-4 border-l-4 border-sky-500 pl-3">記帳與工具</h2>
            <!-- Calculator -->
            <div class="card bg-slate-50 border-0 mb-4 p-4">
                <div class="flex justify-between mb-2">
                    <label class="text-xs font-bold text-slate-500">匯率</label>
                    <input type="number" id="exchange-rate" value="0.22" class="w-16 bg-transparent border-b border-slate-300 text-right text-sm" oninput="window.calc()">
                </div>
                <div class="flex gap-2">
                    <input type="number" id="calc-input" placeholder="日幣金額" class="jp-input text-lg font-bold" oninput="window.calc()">
                </div>
                <div class="text-right mt-2 text-slate-400 text-sm" id="res-twd">TWD $0</div>
            </div>
            
            <button onclick="toggleDrawer(true)" class="w-full bg-white border-2 border-dashed border-slate-200 text-slate-500 py-3 rounded-xl mb-6 font-bold hover:bg-slate-50">
                + 新增消費
            </button>

            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-slate-700">消費明細</h3>
                <button onclick="clearExpHistory()" class="text-xs text-red-400"><i class="fas fa-trash"></i> 清除</button>
            </div>
            <div id="expense-list" class="space-y-2 pb-20"></div>
        </div>

        <!-- SECTION: LISTS -->
        <div id="section-lists" class="tab-content">
            <h2 class="text-xl font-bold text-slate-800 mb-4 border-l-4 border-green-500 pl-3">清單</h2>
            <div class="card p-0 overflow-hidden">
                <div class="flex border-b border-slate-100">
                    <button onclick="switchList('packing')" class="flex-1 py-3 bg-sky-50 text-sky-600 font-bold text-sm">行李清單</button>
                    <button onclick="switchList('memo')" class="flex-1 py-3 text-slate-400 text-sm">備忘錄</button>
                </div>
                <div id="view-packing" class="p-4">
                    <div class="flex gap-2 mb-4">
                        <input id="new-pack" class="jp-input text-sm" placeholder="新增項目...">
                        <button onclick="addPack()" class="bg-sky-500 text-white w-10 rounded-lg">+</button>
                    </div>
                    <div id="packing-container" class="space-y-2"></div>
                </div>
                <div id="view-memo" class="p-4 hidden">
                    <div class="flex gap-2 mb-4">
                        <input id="new-memo" class="jp-input text-sm" placeholder="新增備忘...">
                        <button onclick="addMemo()" class="bg-sky-500 text-white w-10 rounded-lg">+</button>
                    </div>
                    <div id="memo-container" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 w-full bg-white/95 backdrop-blur border-t border-slate-200 pb-safe z-50">
        <div class="flex justify-around items-center h-[60px]">
            <button onclick="nav('plan')" class="nav-item active flex flex-col items-center text-sky-500">
                <i class="fas fa-calendar-alt text-lg"></i><span class="text-[10px]">行程</span>
            </button>
            <button onclick="nav('guide')" class="nav-item flex flex-col items-center text-slate-400">
                <i class="fas fa-map-location-dot text-lg"></i><span class="text-[10px]">導覽</span>
            </button>
            <button onclick="nav('util')" class="nav-item flex flex-col items-center text-slate-400">
                <i class="fas fa-calculator text-lg"></i><span class="text-[10px]">記帳</span>
            </button>
            <button onclick="nav('lists')" class="nav-item flex flex-col items-center text-slate-400">
                <i class="fas fa-check-square text-lg"></i><span class="text-[10px]">清單</span>
            </button>
        </div>
    </nav>

    <!-- Drawer -->
    <div id="expense-drawer" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="toggleDrawer(false)"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-2xl p-6 pb-safe animate-[slideUp_0.3s]">
            <h3 class="font-bold text-center mb-4 text-slate-800">新增消費</h3>
            <div class="flex gap-3 mb-4">
                <label class="flex-1 text-center border rounded p-2 cursor-pointer" id="label-cash">
                    <input type="radio" name="payment-type" value="cash" class="hidden" checked> 現金
                </label>
                <label class="flex-1 text-center border rounded p-2 cursor-pointer" id="label-credit">
                    <input type="radio" name="payment-type" value="credit" class="hidden"> 信用卡
                </label>
            </div>
            <input id="exp-name" class="jp-input mb-3" placeholder="項目名稱">
            <input id="exp-amt" type="number" class="jp-input mb-6 text-xl font-bold" placeholder="¥ 金額">
            <button onclick="saveExp()" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg">儲存</button>
        </div>
    </div>

    <script>
        // --- Static Data ---
        const weatherData = [
            {day:'Day 1', date:'03/19', icon:'☁️', temp:'3°/8°', loc:'函館'},
            {day:'Day 2', date:'03/20', icon:'☀️', temp:'2°/7°', loc:'洞爺'},
            {day:'Day 3', date:'03/21', icon:'☁️', temp:'1°/6°', loc:'札幌'},
            {day:'Day 4', date:'03/22', icon:'❄️', temp:'-1°/4°', loc:'美瑛'},
            {day:'Day 5', date:'03/23', icon:'☀️', temp:'0°/5°', loc:'小樽'},
            {day:'Day 6', date:'03/24', icon:'✈️', temp:'1°/6°', loc:'千歲'},
        ];
        const pois = [
            {n:'函館機場',q:'函館空港'}, {n:'幸運小丑漢堡',q:'幸運小丑漢堡 函館站前店'}, {n:'五稜郭塔',q:'五稜郭塔'},
            {n:'金森紅磚倉庫',q:'金森紅磚倉庫'}, {n:'函館山夜景',q:'函館山ロープウェイ'}, {n:'WE Hotel Toya',q:'WE Hotel Toya'},
            {n:'登別地獄谷',q:'登別地獄谷'}, {n:'尼克斯海洋公園',q:'尼克斯海洋公園'}, {n:'白色戀人公園',q:'白色戀人公園'},
            {n:'旭山動物園',q:'旭山動物園'}, {n:'白鬚瀑布',q:'白鬚瀑布'}, {n:'白金青池',q:'白金青池'},
            {n:'狸小路',q:'狸小路商店街'}, {n:'小樽運河',q:'小樽運河'}, {n:'新千歲機場',q:'新千歲機場'}
        ];

        // --- Render Helpers ---
        function renderWeather() {
            weatherData.forEach((w,i) => {
                const el = document.getElementById(`weather-day-${i+1}`);
                if(el) el.innerHTML = `
                    <div class="flex items-center justify-between bg-gradient-to-r from-sky-400 to-blue-500 text-white p-3 rounded-xl mb-4 shadow-sm">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${w.icon}</span>
                            <div><div class="text-xs font-bold opacity-90">${w.date} ${w.loc}</div><div class="text-sm font-bold">${w.temp}</div></div>
                        </div>
                        <i class="fas fa-cloud-sun opacity-50"></i>
                    </div>`;
            });
        }

        function renderPois() {
            const c = document.getElementById('poi-quick-links');
            c.innerHTML = pois.map(p => `
                <button onclick="openMap('${p.q}')" class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm text-left active:scale-95 transition-transform">
                    <div class="font-bold text-slate-700 text-sm truncate">${p.n}</div>
                    <div class="text-xs text-sky-500 mt-1"><i class="fas fa-location-arrow"></i> 導航</div>
                </button>
            `).join('');
        }

        function switchPlanPage(id) {
            document.querySelectorAll('.plan-page').forEach(e => e.classList.remove('active'));
            document.getElementById(`plan-page-${id}`).classList.add('active');
            document.querySelectorAll('.sub-nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById(`subnav-${id}`).classList.add('active');
            window.scrollTo(0,0);
        }

        function switchList(type) {
            document.getElementById('view-packing').style.display = type==='packing'?'block':'none';
            document.getElementById('view-memo').style.display = type==='memo'?'block':'none';
        }

        function nav(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById(`section-${id}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => {
                e.className = 'nav-item flex flex-col items-center text-slate-400';
            });
            event.currentTarget.className = 'nav-item active flex flex-col items-center text-sky-500';
            window.scrollTo(0,0);
        }

        window.calc = () => {
            const v = document.getElementById('calc-input').value;
            const r = parseFloat(document.getElementById('exchange-rate').value);
            if(v) {
                try {
                    const res = new Function('return ' + v)();
                    document.getElementById('res-twd').innerText = `≈ TWD $${Math.floor(res*r)}`;
                    document.getElementById('exp-amt').value = Math.floor(res);
                } catch(e){}
            }
        };

        // Radio Logic
        document.querySelectorAll('input[name="payment-type"]').forEach(r => {
            r.addEventListener('change', e => {
                document.getElementById('label-cash').style.cssText = '';
                document.getElementById('label-credit').style.cssText = '';
                e.target.parentElement.style.cssText = `background-color: #f0f9ff; border-color: #3b82f6; color: #3b82f6;`;
            });
        });

        // Run
        renderWeather();
        renderPois();
        setTimeout(() => document.getElementById('splash-screen').style.display='none', 1000);
        
        // Setup initial UI states
        document.getElementById('label-cash').style.cssText = `background-color: #f0f9ff; border-color: #3b82f6; color: #3b82f6;`;
    </script>
</body>
</html>