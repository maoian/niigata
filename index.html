<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ–°æ½Ÿç´€è¡Œ | Niigata Trip Planner</title>
    <meta name="apple-mobile-web-app-title" content="æ–°æ½Ÿç´€è¡Œ">
    <meta name="format-detection" content="telephone=no">
    <!-- Android Chrome è¨­å®š -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#fcfcf5">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Noto Sans TC (Main) & Lato (Numbers) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Lato:wght{400;700}&display=swap" rel="stylesheet">
    
    <script>
        // --- PWA Setup and Icon Generation ---
        (function() {
            // Icon SVG (Stylized Torii)
            const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <rect width="512" height="512" fill="#fcfcf5" rx="100"/>
                <!-- Main pillars -->
                <rect x="100" y="150" width="30" height="300" fill="#a84c4c"/>
                <rect x="382" y="150" width="30" height="300" fill="#a84c4c"/>
                <!-- Upper crossbeam -->
                <rect x="40" y="170" width="432" height="30" fill="#a84c4c"/>
                <!-- Top beam -->
                <rect x="70" y="130" width="372" height="30" fill="#a84c4c"/>
                <!-- Central knot/decoration -->
                <circle cx="256" cy="145" r="12" fill="#ffffff"/>
            </svg>`;
            const iconUrl = 'data:image/svg+xml;base64,' + btoa(iconSvg);
            
            // Set Favicon & Apple Icon
            const setLink = (rel, href) => {
                let link = document.createElement('link');
                link.rel = rel;
                link.href = href;
                document.head.appendChild(link);
            };
            setLink('icon', iconUrl);
            setLink('apple-touch-icon', iconUrl);

            // Generate Manifest JSON
            const manifest = {
                "name": "æ–°æ½Ÿç´€è¡Œ",
                "short_name": "æ–°æ½Ÿç´€è¡Œ",
                "start_url": location.href,
                "display": "standalone",
                "background_color": "#fcfcf5",
                "theme_color": "#fcfcf5",
                "orientation": "portrait",
                "icons": [{ "src": iconUrl, "sizes": "512x512", "type": "image/svg+xml" }]
            };
            
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);
            setLink('manifest', manifestURL);
        })();

        // --- Tailwind Configuration (æ—¥ç³»æ’åœ–é¢¨) ---
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-bg': '#fcfcf5',     // Creamy Background
                        'jp-card': '#ffffff',   // White Card
                        'jp-text': '#333333',   // Deep Charcoal Text
                        'jp-accent': '#a84c4c', // Muted Terracotta Red
                        'jp-sub': '#6d8b67',    // Sage Green
                        'jp-border': '#e0e0e0', // Light Border
                        'jp-light': '#f5f5f0',  // Very light gray
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        num: ['"Lato"', 'sans-serif']
                    },
                    padding: {
                        'safe-top': 'env(safe-area-inset-top)',
                        'safe-bottom': 'env(safe-area-inset-bottom)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fcfcf5;
            color: #333333;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overscroll-behavior-y: none;
            /* Adjust padding for 4-item nav bar */
            padding-bottom: calc(80px + env(safe-area-inset-bottom)); 
            min-height: 100vh;
        }

        input, textarea { user-select: text; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .plan-page { display: none; }
        .plan-page.active { display: block; }

        .jp-input {
            border: 1px solid #e0e0e0;
            background-color: #ffffff;
            border-radius: 10px; 
            padding: 12px;
            width: 100%;
            outline: none;
            appearance: none;
            font-size: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .jp-input:focus { border-color: #a84c4c; box-shadow: 0 0 0 2px rgba(168, 76, 76, 0.2); }

        .btn-primary {
            background-color: #a84c4c;
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 500;
            transition: transform 0.1s ease-in-out, opacity 0.2s;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 6px rgba(168, 76, 76, 0.3);
        }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; box-shadow: 0 2px 4px rgba(168, 76, 76, 0.4); }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06); 
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #f0f0f0;
            transition: transform 0.2s, background-color 0.2s;
        }
        .card-clickable:active { transform: scale(0.98); background-color: #fcfcfc; }

        /* Time Highlight */
        .time-highlight {
            font-weight: 700;
            color: #a84c4c; /* Accent Red */
            background-color: #fff3f3;
            padding: 4px 8px;
            border-radius: 6px;
            line-height: 1;
        }

        /* Weather Bar Styling */
        .weather-bar {
            background-color: #6d8b67; /* jp-sub */
            color: white;
            box-shadow: 0 4px 10px rgba(109, 139, 103, 0.3);
            cursor: pointer; /* To indicate it's clickable (for info) */
        }
        .weather-bar:active { transform: scale(0.98); }


        /* Splash Screen & Animation */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #fcfcf5; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        .fade-out { opacity: 0; visibility: hidden; }

        header { padding-top: max(12px, env(safe-area-inset-top)); }
        nav { padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        
        /* Magazine/Guide Styling */
        .guide-article {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            line-height: 1.8;
            font-size: 15px;
            border-left: 5px solid #6d8b67;
        }

        /* Sub-navigation bar for daily itinerary */
        .sub-nav-item {
            padding: 10px 0;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s, border-bottom 0.2s;
            border-bottom: 2px solid transparent;
        }
        .sub-nav-item.active {
            color: #a84c4c;
            border-bottom-color: #a84c4c;
            font-weight: 700;
        }
    </style>
</head>
<body>

    <!-- 1. Splash Screen -->
    <div id="splash-screen">
        <div class="mb-4">
            <!-- Splash Icon (Torii) -->
            <svg width="100" height="100" viewBox="0 0 512 512">
                <rect x="100" y="150" width="30" height="300" fill="#a84c4c"/>
                <rect x="382" y="150" width="30" height="300" fill="#a84c4c"/>
                <rect x="40" y="170" width="432" height="30" fill="#a84c4c"/>
                <rect x="70" y="130" width="372" height="30" fill="#a84c4c"/>
                <circle cx="256" cy="145" r="12" fill="#ffffff"/>
            </svg>
        </div>
        <h1 class="text-3xl font-bold text-jp-text tracking-widest mt-2">æ–°æ½Ÿç´€è¡Œ</h1>
        <p class="text-xs text-jp-accent mt-3 font-num">Autumn Niigata Trip Planner</p>
    </div>

    <!-- Header (Fixed Top) -->
    <header class="fixed top-0 w-full bg-jp-bg/90 backdrop-blur-md z-40 px-4 pb-3 border-b border-jp-border/50 flex justify-between items-end h-[calc(65px+env(safe-area-inset-top))]">
        <div>
            <h1 class="text-xl font-bold tracking-widest text-jp-text">æ–°æ½Ÿç´€è¡Œ</h1>
            <p class="text-[10px] text-jp-sub tracking-wider font-num">Let's go Niigata</p>
        </div>
        <div class="text-right">
            <span class="text-[10px] bg-jp-accent text-white px-3 py-1 rounded-full font-num shadow-sm">2026 AUTUMN</span>
        </div>
    </header>

    <main class="mt-[calc(75px+env(safe-area-inset-top))] px-4 pb-4" id="app">
        
        <!-- SECTION 1: PLAN (Overview + Daily Tabs) -->
        <div id="section-plan" class="tab-content active">

            <!-- Sub-Navigation for Daily Plan -->
            <div class="sticky top-[calc(75px+env(safe-area-inset-top))] z-30 bg-jp-bg/95 backdrop-blur-sm pt-2 pb-1 -mx-4 px-4 border-b border-jp-border">
                <div class="flex justify-between text-center text-gray-500">
                    <button id="subnav-overview" class="sub-nav-item active flex-1" onclick="switchPlanPage('overview')">ç¸½è¦½</button>
                    <button id="subnav-day1" class="sub-nav-item flex-1" onclick="switchPlanPage('day1')">Day 1</button>
                    <button id="subnav-day2" class="sub-nav-item flex-1" onclick="switchPlanPage('day2')">Day 2</button>
                    <button id="subnav-day3" class="sub-nav-item flex-1" onclick="switchPlanPage('day3')">Day 3</button>
                    <button id="subnav-day4" class="sub-nav-item flex-1" onclick="switchPlanPage('day4')">Day 4</button>
                </div>
            </div>

            <!-- SUB-PAGE: OVERVIEW -->
            <div id="plan-page-overview" class="plan-page active pt-4">
                <h2 class="text-xl font-bold text-jp-text mb-4 border-l-4 border-jp-accent pl-3">æ—…è¡Œç¸½è¦½</h2>
                
                <!-- Cover Page (Torii Icon) -->
                <div class="card p-5 mb-6 text-center shadow-lg bg-jp-sub/10">
                    <!-- NEW TORII ICON -->
                    <svg class="mx-auto mb-3" width="60" height="60" viewBox="0 0 512 512">
                        <rect x="100" y="150" width="30" height="300" fill="#a84c4c"/>
                        <rect x="382" y="150" width="30" height="300" fill="#a84c4c"/>
                        <rect x="40" y="170" width="432" height="30" fill="#a84c4c"/>
                        <rect x="70" y="130" width="372" height="30" fill="#a84c4c"/>
                        <circle cx="256" cy="145" r="12" fill="#ffffff"/>
                    </svg>
                    <h3 class="text-2xl font-bold text-jp-text mb-2">2026/10/16 - 10/19 æ–°æ½Ÿå››æ—¥ç´€è¡Œ</h3>
                    <p class="text-sm text-gray-600">æ‚ é–’èˆ‡æ·±åº¦ä¸¦å­˜çš„è¶Šå¾Œä¹‹æ—…</p>
                </div>
                
                <!-- Weather Forecast Block -->
                <div class="weather-bar text-white p-4 rounded-xl mb-6">
                    <h3 class="text-lg font-bold mb-3 flex items-center">
                        <i class="fas fa-cloud-sun text-xl mr-2"></i>
                        æ–°æ½Ÿå¤©æ°£é å ± (10/16 - 10/19)
                    </h3>
                    <div class="grid grid-cols-4 gap-2 text-center text-sm font-medium">
                        <!-- Day 1: 10/16 (äº”) -->
                        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                            <p class="text-xs">10/16 (äº”)</p><p class="text-xl my-0.5">â˜ï¸</p>
                            <p class="text-xs font-num">18Â° / 24Â°</p><p class="text-xs">å¤šé›²</p>
                        </div>
                        <!-- Day 2: 10/17 (å…­) -->
                        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                            <p class="text-xs">10/17 (å…­)</p><p class="text-xl my-0.5">â˜€ï¸</p>
                            <p class="text-xs font-num">20Â° / 26Â°</p><p class="text-xs">æ™´æœ—</p>
                        </div>
                        <!-- Day 3: 10/18 (æ—¥) -->
                        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                            <p class="text-xs">10/18 (æ—¥)</p><p class="text-xl my-0.5">â˜”</p>
                            <p class="text-xs font-num">19Â° / 23Â°</p><p class="text-xs">é™£é›¨</p>
                        </div>
                        <!-- Day 4: 10/19 (ä¸€) -->
                        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                            <p class="text-xs">10/19 (ä¸€)</p><p class="text-xl my-0.5">ğŸŒ¤ï¸</p>
                            <p class="text-xs font-num">18Â° / 25Â°</p><p class="text-xs">å¤šé›²æ™‚æ™´</p>
                        </div>
                    </div>
                </div>

                <!-- Flight Info -->
                <div id="plan-flight" class="mb-6">
                    <h3 class="text-lg font-bold text-jp-sub mb-3">âœˆï¸ èˆªç­è³‡è¨Š</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="card p-3 bg-jp-accent/5">
                            <p class="text-xs font-bold text-jp-accent mb-1">å»ç¨‹ | IT228</p>
                            <div class="flex items-center justify-between text-lg font-num font-bold">
                                <span>TPE 13:45</span><i class="fas fa-arrow-right text-xs"></i><span>KIJ 18:00</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">é•·æ¦®èˆªç©º / é è¨ˆ 4 å°æ™‚ 15 åˆ†é˜</p>
                        </div>
                        <div class="card p-3 bg-jp-accent/5">
                            <p class="text-xs font-bold text-jp-accent mb-1">å›ç¨‹ | IT229</p>
                            <div class="flex items-center justify-between text-lg font-num font-bold">
                                <span>KIJ 18:50</span><i class="fas fa-arrow-right text-xs"></i><span>TPE 21:25</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">é•·æ¦®èˆªç©º / é è¨ˆ 3 å°æ™‚ 35 åˆ†é˜</p>
                        </div>
                    </div>
                </div>

                 <!-- Pre-trip Prep -->
                <div id="plan-prep" class="mb-6">
                    <h3 class="text-lg font-bold text-jp-sub mb-3">âœ… è¡Œå‰æº–å‚™èˆ‡æé†’</h3>
                    <div class="card p-4">
                        <div class="flex items-center gap-3 mb-3 pb-3 border-b border-jp-light">
                            <i class="fas fa-bed text-xl text-gray-500"></i>
                            <div class="flex-1">
                                <span class="font-bold">ä½å®¿ç¢ºèª</span>
                                <p class="text-xs text-jp-accent mt-0.5">å°šæœªæ±ºå®šï¼Œè«‹å„˜é€Ÿé è¨‚ï¼</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-ticket-alt text-xl text-gray-500"></i>
                            <div class="flex-1">
                                <span class="font-bold">JR è¶Šå¾Œç·šè»Šè³‡</span>
                                <p class="text-xs text-gray-500 mt-0.5">å»ºè­°ä½¿ç”¨ Suica æˆ–è³¼è²· JR Passã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SUB-PAGE: DAY 1 -->
            <div id="plan-page-day1" class="plan-page pt-4">
                <h2 class="text-xl font-bold text-jp-text mb-4 border-l-4 border-jp-accent pl-3">ç¬¬ä¸€å¤© (10/16 Fri) | æŠµé”èˆ‡è¬ä»£æ©‹å¤œæ™¯</h2>
                
                <!-- NEW: Daily Weather Bar -->
                <div id="weather-day-1"></div>

                <div class="space-y-3">
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight">18:00</span>
                        <div class="flex-1">
                            <div class="font-bold">æ–°æ½Ÿæ©Ÿå ´ (KIJ) æŠµé”</div>
                            <p class="text-sm text-gray-600 mt-1">é ˜å–è¡Œæã€è³¼è²·å·´å£«ç¥¨ã€‚</p>
                            <button onclick="openMap('æ–°æ½Ÿç©ºæ¸¯')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps</button>
                        </div>
                    </div>
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight bg-jp-accent text-white">18:00-19:00</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸšŒ æ©Ÿå ´å·´å£«å‰å¾€æ–°æ½Ÿç«™</div>
                            <p class="text-sm text-red-500 mt-1 font-bold">å…¨ç¨‹å”¯ä¸€å·´å£«å€æ®µï¼Œè«‹æ³¨æ„ç­æ¬¡ã€‚</p>
                            <button onclick="openMap('æ–°æ½Ÿé§…')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps (ç›®çš„åœ°)</button>
                        </div>
                    </div>
                     <div class="card flex items-start gap-3">
                        <span class="time-highlight">19:00</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸ  æ–°æ½Ÿç«™å‘¨é‚Šï¼Œè¾¦ç†å…¥ä½</div>
                            <p class="text-sm text-gray-600 mt-1">åœ°é»å¾…å®šï¼Œè«‹æº–å‚™è­·ç…§ã€‚</p>
                        </div>
                    </div>
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight">19:30-21:30</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸ½ï¸ æ™šé¤ï¼šæ–°æ½Ÿç«™å‘¨é‚Šç¾é£Ÿ</div>
                            <p class="text-sm text-gray-600 mt-1">æ¨è–¦ï¼šç•¶åœ°å£½å¸æˆ– ã¸ããã° (Hegi Soba)</p>
                            <div class="flex gap-2 mt-2">
                                <button onclick="openMap('æ–°æ½Ÿé§… å£½å¸')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps</button>
                                <button onclick="openFood('æ–°æ½Ÿç«™ ç¾é£Ÿ')" class="text-xs bg-jp-light text-gray-600 py-1 px-3 rounded-full"><i class="fas fa-utensils mr-1"></i> æŸ¥çœ‹é£Ÿè¨˜</button>
                            </div>
                        </div>
                    </div>
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight">21:30</span>
                        <div class="flex-1">
                            <div class="font-bold">è¬ä»£æ©‹ å¤œæ™¯æ•£æ­¥</div>
                            <p class="text-sm text-gray-600 mt-1">æ¬£è³ä¿¡æ¿ƒå·è¿·äººå¤œæ™¯ï¼Œæ¶ˆåŒ–æ™šé¤ã€‚</p>
                            <button onclick="openMap('è¬ä»£æ©‹')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SUB-PAGE: DAY 2 -->
            <div id="plan-page-day2" class="plan-page pt-4">
                <h2 class="text-xl font-bold text-jp-text mb-4 border-l-4 border-jp-accent pl-3">ç¬¬äºŒå¤© (10/17 Sat) | æ–‡é’èˆ‡å¤•é™½</h2>
                
                <!-- NEW: Daily Weather Bar -->
                <div id="weather-day-2"></div>

                <div class="space-y-3">
                     <div class="card flex items-start gap-3">
                        <span class="time-highlight">09:00-10:00</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸ¶ Ponshukan é©›åº— (ã½ã‚“ã—ã‚…é¤¨)</div>
                            <p class="text-sm text-gray-600 mt-1">æ¸…é…’æŠ•å¹£è©¦é£²ï¼Œæ„Ÿå—æ–°æ½Ÿç±³é­‚ã€‚</p>
                            <button onclick="openMap('ã½ã‚“ã—ã‚…é¤¨ æ–°æ½Ÿ')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps</button>
                        </div>
                    </div>
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight">10:30-13:40</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸš¶ æ²¼å‚éœ²è‡ºå•†åº—è¡— (2.0 km)</div>
                            <p class="text-sm text-gray-600 mt-1">æ–‡å‰µæ•£ç­–ï¼ŒèˆŠå¸‚å ´å€çš„æ–‡é’é‡ç”Ÿæ°›åœã€‚æ–¼æ­¤è™•äº«ç”¨åˆé¤ã€‚</p>
                            <button onclick="openMap('æ²¼å‚ãƒ†ãƒ©ã‚¹å•†åº—è¡—')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps</button>
                        </div>
                    </div>
                     <div class="card flex items-start gap-3">
                        <span class="time-highlight">13:40-15:10</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸš¶ ç™½å±±ç¥ç¤¾èˆ‡ç™½å±±å…¬åœ’ (2.5 km)</div>
                            <p class="text-sm text-gray-600 mt-1">æ—¥ç³»åˆç§‹çš„èŠåš´èˆ‡åŸå¸‚ç¶ æ„ã€‚</p>
                            <button onclick="openMap('ç™½å±±ç¥ç¤¾')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps</button>
                        </div>
                    </div>
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight">16:00-17:30</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸ™ï¸ æ–°æ½Ÿæ—¥å ±å‚³åª’å¤§å»ˆ (Media Ship)</div>
                            <p class="text-sm text-gray-600 mt-1">å…è²»è§€æ™¯å°ï¼Œè§€è³æ—¥è½å’Œä¿¡æ¿ƒå·ç¾æ™¯ã€‚</p>
                            <button onclick="openMap('æ–°æ½Ÿæ—¥å ±ãƒ¡ãƒ‡ã‚£ã‚¢ã‚·ãƒƒãƒ—')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps</button>
                        </div>
                    </div>
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight">17:30-21:00</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸ›ï¸ è¬ä»£City è³¼ç‰©èˆ‡æ™šé¤</div>
                            <p class="text-sm text-gray-600 mt-1">æ™šé¤æ¨è–¦ï¼šè¬ä»£City å‘¨é‚Š (æ­¥è¡Œå¯é”)ã€‚</p>
                            <button onclick="openMap('è¬ä»£ã‚·ãƒ†ã‚£')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SUB-PAGE: DAY 3 -->
            <div id="plan-page-day3" class="plan-page pt-4">
                <h2 class="text-xl font-bold text-jp-text mb-4 border-l-4 border-jp-accent pl-3">ç¬¬ä¸‰å¤© (10/18 Sun) | å½Œå½¥ç¥ç¤¾èˆ‡æµ·å²¸ç·š</h2>
                
                <!-- NEW: Daily Weather Bar -->
                <div id="weather-day-3"></div>
                
                <div class="space-y-3">
                    <div class="card flex items-start gap-3 bg-red-50 border-red-200">
                        <span class="time-highlight bg-red-600 text-white">07:30</span>
                        <div class="flex-1">
                            <div class="font-bold text-red-800">ğŸšƒ JR è¶Šå¾Œç·š å‡ºç™¼</div>
                            <p class="text-sm text-red-600 mt-1 font-bold">æ–¼ <span class="underline">å‰ç”°ç«™ (Yoshida)</span> è½‰ä¹˜ JR å½Œå½¥ç·šã€‚å–®ç¨‹ç´„ 70 åˆ†é˜ã€‚</p>
                            <button onclick="openMap('JR å¼¥å½¦é§…')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps (ç›®çš„åœ°)</button>
                        </div>
                    </div>
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight">08:40-12:00</span>
                        <div class="flex-1">
                            <div class="font-bold">â›©ï¸ å½Œå½¥ç¥ç¤¾å€åŸŸå·¡ç¦®</div>
                            <p class="text-sm text-gray-600 mt-1">è€è¡—æ•£æ­¥ã€ç¥ç¤¾åƒæ‹œã€å¯æ­çºœè»Šä¸Šå±±ã€‚</p>
                            <button onclick="openMap('å½Œå½¥ç¥ç¤¾')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps</button>
                        </div>
                    </div>
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight">12:00</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸ½ï¸ å½Œå½¥ç«™å‘¨é‚Šåˆé¤</div>
                            <p class="text-sm text-gray-600 mt-1">åœ¨è€è¡—é™„è¿‘å°‹æ‰¾ç‰¹è‰²é¤å»³ã€‚</p>
                        </div>
                    </div>
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight">13:30-14:00</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸšƒ JR å½Œå½¥ç·š â†’ ç™½å±±ç«™</div>
                            <p class="text-sm text-gray-600 mt-1">æ­ä¹˜çŸ­é€” JR å‰å¾€ç™½å±±ã€‚</p>
                        </div>
                    </div>
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight">14:25-16:40</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸš¶ æ–°æ½Ÿç¸£è­·åœ‹ç¥ç¤¾ (1.8 km æ­¥è¡Œ)</div>
                            <p class="text-sm text-gray-600 mt-1">é è¿‘æµ·å²¸ç·šçš„å®å‰ç¥ç¤¾ï¼Œæ„Ÿå—èŠåš´æ°›åœã€‚</p>
                            <button onclick="openMap('æ–°æ½ŸçœŒè­·å›½ç¥ç¤¾')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps</button>
                        </div>
                    </div>
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight">17:00</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸšƒ JR ç™½å±±ç«™è¿”å›æ–°æ½Ÿç«™</div>
                            <p class="text-sm text-gray-600 mt-1">æº–å‚™æ™šé¤ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SUB-PAGE: DAY 4 -->
            <div id="plan-page-day4" class="plan-page pt-4">
                <h2 class="text-xl font-bold text-jp-text mb-4 border-l-4 border-jp-accent pl-3">ç¬¬å››å¤© (10/19 Mon) | è³¼ç‰©èˆ‡è³¦æ­¸</h2>
                
                <!-- NEW: Daily Weather Bar -->
                <div id="weather-day-4"></div>

                <div class="space-y-3">
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight">09:30-12:00</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸ›ï¸ è³¼ç‰©è¡åˆºï¼šCoCoLo Niigata</div>
                            <p class="text-sm text-gray-600 mt-1">é‡é»è£œè²¨ï¼šæ¸…é…’ã€æ–°æ½Ÿç±³ã€ç±³è“ä»™è²ã€åœ¨åœ°ç”œé»ã€‚</p>
                            <button onclick="openMap('CoCoLo æ–°æ½Ÿ')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps</button>
                        </div>
                    </div>
                    <div class="card flex items-start gap-3">
                        <span class="time-highlight">12:00-14:00</span>
                        <div class="flex-1">
                            <div class="font-bold">ğŸ½ï¸ æœ€å¾Œåˆé¤</div>
                            <p class="text-sm text-gray-600 mt-1">æ¨è–¦ï¼šè»Šç«™å‘¨é‚Šæµ·é®® æˆ– è¬ä»£City å·´å£«ä¸­å¿ƒå’–å“©ã€‚</p>
                            <button onclick="openMap('è¬ä»£ã‚·ãƒ†ã‚£ãƒã‚¹ã‚»ãƒ³ã‚¿ãƒ¼ã®ã‚«ãƒ¬ãƒ¼')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps</button>
                        </div>
                    </div>
                    <div class="card flex items-start gap-3 bg-red-50 border-red-200">
                        <span class="time-highlight bg-red-600 text-white">15:30-16:00</span>
                        <div class="flex-1">
                            <div class="font-bold text-red-800">ğŸ›« å‰å¾€æ–°æ½Ÿæ©Ÿå ´ (KIJ)</div>
                            <p class="text-sm text-red-600 mt-1 font-bold">æ­ä¹˜å·´å£«æˆ–è¨ˆç¨‹è»Šã€‚é ç•™å……è£•æ™‚é–“ã€‚</p>
                            <button onclick="openMap('æ–°æ½Ÿç©ºæ¸¯')" class="text-xs bg-jp-sub/10 text-jp-sub py-1 px-3 rounded-full mt-2"><i class="fas fa-map-marker-alt mr-1"></i> Google Maps (ç›®çš„åœ°)</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="h-20"></div> <!-- Spacer -->
        </div>

        <!-- SECTION 2: GUIDE (Magazine Style) -->
        <div id="section-guide" class="tab-content">
            <h2 class="text-xl font-bold text-jp-text mb-4 border-l-4 border-jp-sub pl-3">æ·±åº¦å°è¦½</h2>
            
             <!-- NEW: Map Quick Links -->
            <div class="mb-8">
                 <h3 class="font-bold text-lg text-jp-accent mb-3 flex items-center"><i class="fas fa-compass mr-2"></i> åœ°é»å¿«é€Ÿå°èˆª (Google Maps)</h3>
                 <div class="grid grid-cols-2 gap-3" id="poi-quick-links">
                     <!-- Populated by JavaScript -->
                 </div>
            </div>

            <!-- Guide Item 1: å½Œå½¥ç¥ç¤¾ -->
            <div class="guide-article">
                <h3 class="font-bold text-lg text-jp-accent mb-3">â›©ï¸ å½Œå½¥ç¥ç¤¾ (D3)</h3>
                <p class="text-gray-700">å½Œå½¥ç¥ç¤¾è¢«å°Šç‚ºã€Œè¶Šå¾Œä¸€å®®ã€ï¼Œä¾›å¥‰è‘—æ•™å°è¶Šå¾Œäººå€‘è¾²è€•æ¼çµçš„ç¥æ˜ã€Œå¤©é¦™å±±å‘½ã€ã€‚é€™è£¡å¤æœ¨åƒå¤©ï¼Œæ°£æ°›èŠåš´ï¼Œæ˜¯æ–°æ½Ÿç¸£å…§æœ€å…·ä»£è¡¨æ€§çš„èƒ½é‡æ™¯é»ã€‚åœ¨ç¥ç¤¾å‘¨é‚Šçš„è€è¡—å€ï¼Œå¯ä»¥æ‰¾åˆ°è¨±å¤šç•¶åœ°ç‰¹è‰²çš„å‚³çµ±é»å¿ƒèˆ‡ç¾é£Ÿã€‚</p>
                <div class="mt-4 pt-4 border-t border-jp-border">
                    <h4 class="text-sm font-bold text-jp-sub mb-2">äº¤é€šæç¤º</h4>
                    <p class="text-xs text-gray-600">å¾æ–°æ½Ÿå¸‚å€éœ€æ­ä¹˜ JR è¶Šå¾Œç·šä¸¦åœ¨å‰ç”°ç«™è½‰ä¹˜ JR å½Œå½¥ç·šï¼Œå»ºè­°æŸ¥è©¢å¥½ç•¶æ—¥åˆ—è»Šæ™‚åˆ»è¡¨ã€‚</p>
                </div>
            </div>

            <!-- Guide Item 2: æ²¼å‚éœ²è‡ºå•†åº—è¡— -->
            <div class="guide-article">
                <h3 class="font-bold text-lg text-jp-accent mb-3">ğŸ›ï¸ æ²¼å‚éœ²è‡ºå•†åº—è¡— (D2)</h3>
                <p class="text-gray-700">å¾èˆŠå¸‚å ´è›»è®Šè€Œæˆçš„æ–‡å‰µèšè½ï¼Œå……æ»¿äº†æ‡·èˆŠçš„é•·å±‹å»ºç¯‰ã€‚æ¯é–“åº—é‹ªéƒ½ç¨å…·ç‰¹è‰²ï¼ŒåŒ…æ‹¬ç¨ç«‹å’–å•¡é¤¨ã€æ‰‹å·¥è—å“åº—å’Œç‰¹è‰²é¤å»³ï¼Œæ˜¯æ„Ÿå—æ–°æ½ŸåŸå¸‚æ–‡é’æ°£æ¯çš„çµ•ä½³åœ°é»ã€‚</p>
                <div class="mt-4 pt-4 border-t border-jp-border">
                    <h4 class="text-sm font-bold text-jp-sub mb-2">åƒè§€å»ºè­°</h4>
                    <p class="text-xs text-gray-600">å•†åº—è¡—é€±äºŒå…¬ä¼‘å±…å¤šï¼Œè«‹é¿é–‹æ­¤æ—¥æœŸã€‚å»ºè­°ä¸Šåˆè‡³ä¸­åˆå‰å¾€ï¼Œäººæ½®è¼ƒå°‘ä¸”æ°£æ°›æ‚ é–’ã€‚</p>
                </div>
            </div>
            
            <!-- Guide Item 3: æ–°æ½Ÿç¸£è­·åœ‹ç¥ç¤¾ -->
            <div class="guide-article">
                <h3 class="font-bold text-lg text-jp-accent mb-3">ğŸŒŠ æ–°æ½Ÿç¸£è­·åœ‹ç¥ç¤¾ (D3)</h3>
                <p class="text-gray-700">è­·åœ‹ç¥ç¤¾é è¿‘æµ·å²¸ç·šï¼Œå¢ƒå…§å»£é—Šä¸”ç’°å¢ƒå„ªç¾ï¼Œæ˜¯ç‚ºäº†ç´€å¿µç‚ºåœ‹çŠ§ç‰²çš„è‹±éˆè€Œå»ºç«‹ã€‚å…¶å®å‰çš„è¦æ¨¡èˆ‡èŠåš´çš„æ°›åœï¼Œèˆ‡å‘¨é‚Šçš„åŸå¸‚æ™¯è§€å½¢æˆäº†é®®æ˜çš„å°æ¯”ã€‚</p>
                <div class="mt-4 pt-4 border-t border-jp-border">
                    <h4 class="text-sm font-bold text-jp-sub mb-2">å‘¨é‚Šæ™¯é»</h4>
                    <p class="text-xs text-gray-600">æ²¿è‘—æµ·å²¸ç·šæ•£æ­¥å¯åˆ°é”ã€Œè¥¿æµ·å²¸å…¬åœ’ã€ï¼Œå¤©æ°£å¥½æ™‚æ˜¯æ¬£è³æ—¥æœ¬æµ·å¤•é™½çš„çµ•ä½³ä½ç½®ã€‚</p>
                </div>
            </div>
        </div>

        <!-- SECTION 3: UTILITY (Accounting + Info/Contacts) - MERGED SECTION -->
        <div id="section-util" class="tab-content">
            <h2 class="text-xl font-bold text-jp-text mb-4 border-l-4 border-jp-accent pl-3">å…¬ç”¨å·¥å…·èˆ‡è¨˜å¸³</h2>
            
            <!-- Sub-Section 1: Calculator & Expense Tracking -->
            <div class="mb-8">
                 <h3 class="text-lg font-bold text-jp-sub mb-3"><i class="fas fa-calculator mr-2"></i>åŒ¯ç‡è¨ˆç®—èˆ‡è¨˜å¸³</h3>
                <!-- Calculator Card (Sticky is removed here, for easier scrolling) -->
                <div class="card bg-jp-sub/10 border-0 mb-4">
                    <div class="flex items-center justify-between mb-2 opacity-80">
                        <label class="text-xs font-bold text-jp-text">åŒ¯ç‡ (JPY â†’ TWD)</label>
                        <input type="number" id="exchange-rate" value="0.220" class="w-20 text-right bg-transparent border-b border-jp-sub text-sm font-num focus:outline-none" oninput="calc()" step="0.001">
                    </div>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="calc-input" placeholder="500+200*3" class="jp-input py-2 flex-1 text-xl font-num shadow-inner" inputmode="decimal" onkeyup="if(event.key==='Enter')calc()">
                        <button onclick="calc()" class="bg-jp-accent text-white w-14 rounded-xl shadow-md active:scale-95"><i class="fas fa-calculator text-lg"></i></button>
                    </div>
                    <div class="flex justify-between items-end mt-1">
                        <div class="text-2xl font-bold font-num text-jp-text" id="res-jpy">Â¥0</div>
                        <div class="text-xl font-bold font-num text-jp-sub" id="res-twd">TWD $0</div>
                    </div>
                </div>

                <!-- Quick Add -->
                <button onclick="toggleDrawer(true)" class="w-full bg-jp-card border border-dashed border-jp-border text-jp-text py-3 rounded-xl mb-4 hover:bg-jp-light active:scale-98 transition-transform">
                    <i class="fas fa-plus mr-1 text-jp-sub"></i> æ–°å¢ä¸€ç­†æ”¯å‡º
                </button>
                
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-jp-text">æ¶ˆè²»è¨˜éŒ„</h3>
                    <button onclick="clearExpHistory()" class="text-xs text-red-400 hover:text-red-600"><i class="fas fa-trash-alt mr-1"></i>æ¸…é™¤æ‰€æœ‰è¨˜éŒ„</button>
                </div>

                <!-- List -->
                <div id="expense-list" class="space-y-2"></div>
            </div>
            
            <!-- Sub-Section 2: Important Info and Contacts (Content moved from old section-info) -->
            <div class="mb-6">
                 <h3 class="text-lg font-bold text-jp-sub mb-3"><i class="fas fa-info-circle mr-2"></i>é‡è¦è³‡è¨Šèˆ‡æç¤º</h3>
                <!-- Quick Links -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="card flex flex-col items-center justify-center py-5 active:scale-95 bg-blue-50">
                        <i class="fas fa-cloud-sun text-3xl text-blue-500 mb-2"></i>
                        <span class="font-bold text-sm">ç•¶åœ°å¤©æ°£é å ±</span>
                        <span class="text-xs text-gray-500 mt-1">æ—¥æœ¬æ°£è±¡å»³</span>
                    </a>
                    <a href="tel:+81-110" class="card flex flex-col items-center justify-center py-5 active:scale-95 bg-red-50">
                        <i class="fas fa-phone-alt text-3xl text-red-500 mb-2"></i>
                        <span class="font-bold text-sm">ç·Šæ€¥è¯ç¹« (è­¦å¯Ÿ)</span>
                        <span class="text-xs text-gray-500 mt-1">é»æ“Šæ’¥æ‰“ï¼š110</span>
                    </a>
                </div>

                <!-- Travel Tips -->
                <div class="card p-5">
                    <h3 class="font-bold text-lg text-jp-accent mb-3">âœˆï¸ æ—…éŠæ³¨æ„äº‹é …</h3>
                    <ul class="text-sm space-y-3 list-disc pl-5 text-gray-700">
                        <li>**è™èˆªæ‰‹æè¡Œæï¼š** æ¯äººé™ 2 ä»¶ï¼Œç¸½é‡ä¸è¶…é 10 å…¬æ–¤ã€‚å‹™å¿…æ³¨æ„å°ºå¯¸é™åˆ¶ã€‚</li>
                        <li>**æ¶²é«”å®¹é‡ï¼š** éš¨èº«è¡Œææ¶²é«”å–®ç“¶ä¸è¶…é 100mlï¼Œç¸½å®¹é‡ä¸è¶…é 1Lï¼Œéœ€è£å…¥é€æ˜å¯†å°è¢‹ã€‚</li>
                        <li>**æµ·é—œç”³å ±ï¼š** æ”œå¸¶ç¾é‡‘è¶…é 100 è¬æ—¥åœ“æˆ–ç­‰å€¼ç‰©å“éœ€ç”³å ±ã€‚è‚‰è£½å“ã€ç”Ÿæœåš´ç¦å¸¶å…¥ã€‚</li>
                        <li>**å……é›»ç¦®å„€ï¼š** åœ¨å…¬å…±å ´æ‰€ï¼ˆå¦‚è»Šç«™ã€é¤å»³ï¼‰æœªç¶“å…è¨±è«‹å‹¿è‡ªè¡Œæ’é›»å……é›»ã€‚</li>
                    </ul>
                </div>
            </div>
            <div class="h-20"></div> <!-- Spacer -->
        </div>

        <!-- SECTION 4: LISTS (Checklist & Memo) -->
        <div id="section-lists" class="tab-content">
            <h2 class="text-xl font-bold text-jp-text mb-4 border-l-4 border-jp-accent pl-3">æ¸…å–® & å‚™å¿˜</h2>
            <div class="bg-jp-card rounded-xl shadow-lg overflow-hidden min-h-[400px]">
                <div class="flex border-b border-jp-border">
                    <button onclick="switchList('packing')" id="tab-packing" class="flex-1 py-3 bg-jp-accent/10 text-jp-accent font-bold text-sm border-b-2 border-jp-accent transition-all">âœ… è¡Œå‰æº–å‚™</button>
                    <button onclick="switchList('memo')" id="tab-memo" class="flex-1 py-3 text-gray-400 text-sm transition-all">ğŸ“ å€‹äººå‚™å¿˜éŒ„</button>
                </div>
                <div class="p-4" id="list-content">
                    <!-- Packing -->
                    <div id="view-packing">
                        <div id="packing-container" class="space-y-2"></div>
                        <div class="mt-4 flex gap-2">
                            <input type="text" id="new-pack" class="jp-input py-2 text-sm" placeholder="æ–°å¢æ—…è¡Œå¿…å‚™å“...">
                            <button onclick="addPack()" class="btn-primary py-2 px-4 shadow-none"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <!-- Memo -->
                    <div id="view-memo" class="hidden">
                        <div id="memo-container" class="space-y-3 mb-4"></div>
                        <textarea id="new-memo" class="jp-input text-sm" rows="3" placeholder="è¼¸å…¥å‚™å¿˜å…§å®¹ï¼Œç¶²å€æœƒè‡ªå‹•è½‰æ›æˆé€£çµã€‚"></textarea>
                        <button onclick="addMemo()" class="btn-primary w-full mt-2 shadow-md bg-jp-sub">å„²å­˜å‚™å¿˜</button>
                    </div>
                </div>
            </div>
            <div class="h-20"></div> <!-- Spacer -->
        </div>

    </main>

    <!-- Bottom Nav (Normalized Utility Icon) -->
    <nav class="fixed bottom-0 w-full bg-white/90 backdrop-blur-md border-t border-gray-200 pb-safe z-50">
        <div class="flex justify-around items-center h-[65px]">
            <button onclick="nav('plan')" class="nav-item active flex-1 h-full flex flex-col items-center justify-center text-gray-400">
                <i class="fas fa-route text-lg mb-1"></i><span class="text-[10px]">è¡Œç¨‹</span>
            </button>
            <button onclick="nav('guide')" class="nav-item flex-1 h-full flex flex-col items-center justify-center text-gray-400">
                <i class="fas fa-book-open text-lg mb-1"></i><span class="text-[10px]">å°è¦½</span>
            </button>
            <!-- CHANGE 2: Normalized Utility Icon -->
            <button onclick="nav('util')" class="nav-item flex-1 h-full flex flex-col items-center justify-center text-gray-400">
                <i class="fas fa-wallet text-lg mb-1"></i><span class="text-[10px]">è¨˜å¸³</span>
            </button>
            <button onclick="nav('lists')" class="nav-item flex-1 h-full flex flex-col items-center justify-center text-gray-400">
                <i class="fas fa-check-square text-lg mb-1"></i><span class="text-[10px]">æ¸…å–®</span>
            </button>
        </div>
    </nav>

    <!-- Expense Drawer (For Utility Add) -->
    <div id="expense-drawer" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="toggleDrawer(false)"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-2xl p-5 pb-safe animate-slide-up shadow-2xl">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-4"></div>
            <h3 class="text-center font-bold mb-4 text-lg">æ–°å¢æ¶ˆè²»è¨˜éŒ„</h3>
            <input type="text" id="exp-name" class="jp-input mb-3" placeholder="å“é …åç¨± (å¦‚: æ™šé¤/æ¸…é…’)">
            <input type="number" id="exp-amt" class="jp-input mb-4 text-xl font-num" placeholder="æ—¥å¹£é‡‘é¡ (JPY)">
            
            <div class="flex items-center gap-2 mb-5">
                <label class="flex-1 border border-dashed border-jp-sub/50 rounded-lg p-3 text-center text-gray-600 text-sm active:bg-jp-light">
                    <i class="fas fa-camera mr-2 text-jp-sub"></i> æ‹ç…§å­˜è­‰ (è‡ªå‹•å£“ç¸®)
                    <input type="file" id="exp-img" accept="image/*" class="hidden" capture="environment" onchange="previewImg(this)">
                </label>
                <div id="img-check" class="hidden text-green-500 flex-shrink-0"><i class="fas fa-check-circle text-2xl"></i></div>
            </div>

            <button onclick="saveExp()" class="btn-primary w-full text-lg shadow-xl bg-jp-accent">ç¢ºå®šå„²å­˜</button>
        </div>
    </div>

    <style>
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .nav-item.active { color: #a84c4c; font-weight: 500; }
    </style>

    <script>
        // --- Global Data (For Weather and POI) ---
        const tripWeather = [
            { date: '10/16 (äº”)', temp: '18Â° / 24Â°', icon: 'â˜ï¸', desc: 'å¤šé›²', dayText: 'ç¬¬ä¸€å¤©' },
            { date: '10/17 (å…­)', temp: '20Â° / 26Â°', icon: 'â˜€ï¸', desc: 'æ™´æœ—', dayText: 'ç¬¬äºŒå¤©' },
            { date: '10/18 (æ—¥)', temp: '19Â° / 23Â°', icon: 'â˜”', desc: 'é™£é›¨', dayText: 'ç¬¬ä¸‰å¤©' },
            { date: '10/19 (ä¸€)', temp: '18Â° / 25Â°', icon: 'ğŸŒ¤ï¸', desc: 'å¤šé›²æ™‚æ™´', dayText: 'ç¬¬å››å¤©' },
        ];
        
        // CHANGE 3: Consolidated POI List for Quick Links
        const tripPOIs = [
            { name: 'æ–°æ½Ÿæ©Ÿå ´ (KIJ)', query: 'æ–°æ½Ÿç©ºæ¸¯', day: 'D1, D4' },
            { name: 'æ–°æ½Ÿç«™ (Niigata Sta.)', query: 'æ–°æ½Ÿé§…', day: 'D1' },
            { name: 'è¬ä»£æ©‹', query: 'è¬ä»£æ©‹', day: 'D1' },
            { name: 'Ponshukan (ã½ã‚“ã—ã‚…é¤¨)', query: 'ã½ã‚“ã—ã‚…é¤¨ æ–°æ½Ÿ', day: 'D2' },
            { name: 'æ²¼å‚éœ²è‡ºå•†åº—è¡—', query: 'æ²¼å‚ãƒ†ãƒ©ã‚¹å•†åº—è¡—', day: 'D2' },
            { name: 'ç™½å±±ç¥ç¤¾', query: 'ç™½å±±ç¥ç¤¾', day: 'D2' },
            { name: 'æ–°æ½Ÿæ—¥å ±å‚³åª’å¤§å»ˆ', query: 'æ–°æ½Ÿæ—¥å ±ãƒ¡ãƒ‡ã‚£ã‚¢ã‚·ãƒƒãƒ—', day: 'D2' },
            { name: 'è¬ä»£City', query: 'è¬ä»£ã‚·ãƒ†ã‚£', day: 'D2' },
            { name: 'å½Œå½¥ç¥ç¤¾', query: 'å½Œå½¥ç¥ç¤¾', day: 'D3' },
            { name: 'æ–°æ½Ÿç¸£è­·åœ‹ç¥ç¤¾', query: 'æ–°æ½ŸçœŒè­·å›½ç¥ç¤¾', day: 'D3' },
            { name: 'CoCoLo Niigata', query: 'CoCoLo æ–°æ½Ÿ', day: 'D4' },
            { name: 'å·´å£«ä¸­å¿ƒå’–å“©', query: 'è¬ä»£ã‚·ãƒ†ã‚£ãƒã‚¹ã‚»ãƒ³ã‚¿ãƒ¼ã®ã‚«ãƒ¬ãƒ¼', day: 'D4' },
        ];

        let tmpImg = null; // Temp storage for Base64 image during expense creation

        // 1. Navigation (Main Tabs: plan, guide, util, lists)
        function nav(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('section-' + id).classList.add('active');
            
            // 1. Reset all nav items
            document.querySelectorAll('.nav-item').forEach(e => {
                e.classList.remove('active');
                e.querySelector('i')?.classList.remove('text-jp-accent');
            });

            // 2. Find current button and set active style
            const navItems = document.querySelectorAll('.nav-item');
            const navIds = ['plan', 'guide', 'util', 'lists'];
            const idx = navIds.indexOf(id);

            if (idx !== -1) {
                const currentNavItem = navItems[idx];
                currentNavItem.classList.add('active');
                // The icon is the first 'i' tag child in the button
                const icon = currentNavItem.querySelector('i');
                if (icon) icon.classList.add('text-jp-accent');
            }
            window.scrollTo(0,0);
        }

        // 1.1. Plan Sub-Navigation (Overview, Day 1-4)
        function switchPlanPage(pageId) {
            document.querySelectorAll('.plan-page').forEach(e => e.classList.remove('active'));
            document.getElementById('plan-page-' + pageId).classList.add('active');
            
            document.querySelectorAll('.sub-nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('subnav-' + pageId).classList.add('active');
            
            window.scrollTo(0,0); // Scroll to top when switching sub-pages
        }

        // Utility: Open Map/Food Search 
        function openMap(q) { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent('æ–°æ½Ÿ ' + q)}`, '_blank'); }
        function openFood(q) { window.open(`https://www.google.com/search?q=${encodeURIComponent('æ–°æ½Ÿ ' + q + ' é£Ÿè¨˜')}`, '_blank'); }

        // --- Weather Bar Function (CHANGE 1 helper) ---
        function getWeatherBarHtml(dayIndex) {
            if (dayIndex >= 0 && dayIndex < tripWeather.length) {
                const w = tripWeather[dayIndex];
                return `
                    <div class="weather-bar text-white p-3 rounded-xl mb-4 flex items-center justify-between shadow-md" onclick="window.open('https://www.jma.go.jp/bosai/forecast/','_blank')">
                        <div class="flex items-center">
                            <span class="text-3xl mr-3">${w.icon}</span>
                            <div>
                                <p class="text-sm font-bold">${w.dayText} (${w.date.split(' ')[0]}) å¤©æ°£</p>
                                <p class="text-xs">${w.desc} | ${w.temp}</p>
                            </div>
                        </div>
                        <div class="text-xs font-medium bg-white/20 px-2 py-1 rounded-full"><i class="fas fa-external-link-alt mr-1"></i> æŸ¥çœ‹è©³æƒ…</div>
                    </div>
                `;
            }
            return '';
        }
        
        // --- POI Quick Links Renderer (CHANGE 3 implementation) ---
        function renderPoiQuickLinks() {
            const container = document.getElementById('poi-quick-links');
            if (!container) return;

            container.innerHTML = tripPOIs.map(poi => `
                <button onclick="openMap('${poi.query}')" class="card flex flex-col items-start justify-center p-3 text-left active:scale-98 hover:bg-jp-light/50 transition-transform">
                    <span class="font-bold text-sm text-jp-text">${poi.name}</span>
                    <span class="text-xs text-jp-sub mt-1"><i class="fas fa-map-marker-alt mr-1"></i> ${poi.day}</span>
                </button>
            `).join('');
        }


        // 2. UTILITY Logic (Calculator, Photo Compression, Expense Save/Render)

        function calc() {
            const v = document.getElementById('calc-input').value;
            const r = parseFloat(document.getElementById('exchange-rate').value);
            
            if (isNaN(r) || !v) {
                document.getElementById('res-jpy').innerText = 'Â¥0';
                document.getElementById('res-twd').innerText = 'TWD $0';
                document.getElementById('exp-amt').value = '';
                return;
            }

            try {
                // Use Function() to safely evaluate the math expression
                const res = new Function('return '+v.replace(/[^\d\+\-\*\/\.]/g, ''))();
                
                const jpy = Math.floor(res);
                const twd = Math.floor(res * r);
                
                document.getElementById('res-jpy').innerText = 'Â¥' + jpy.toLocaleString('ja-JP');
                document.getElementById('res-twd').innerText = 'TWD $' + twd.toLocaleString('zh-TW');
                
                document.getElementById('exp-amt').value = jpy;

            } catch(e){
                document.getElementById('res-jpy').innerText = 'Â¥??';
                document.getElementById('res-twd').innerText = 'TWD $??';
            }
        }

        function toggleDrawer(show) {
            const d = document.getElementById('expense-drawer');
            d.style.display = show ? "block" : "none";
            if (!show) {
                document.getElementById('exp-name').value = '';
                document.getElementById('exp-amt').value = '';
                document.getElementById('img-check').classList.add('hidden');
                tmpImg = null;
            }
        }
        
        function previewImg(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const MAX_WIDTH = 400; 
                        const c = document.createElement('canvas');
                        const ctx = c.getContext('2d');
                        
                        const scaleFactor = MAX_WIDTH / img.width;
                        c.width = MAX_WIDTH;
                        c.height = img.height * scaleFactor;

                        ctx.drawImage(img, 0, 0, c.width, c.height);
                        
                        tmpImg = c.toDataURL('image/jpeg', 0.6); 
                        document.getElementById('img-check').classList.remove('hidden');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function getExps() { return JSON.parse(localStorage.getItem('trip_exps')||'[]'); }
        
        function saveExp() {
            const n = document.getElementById('exp-name').value.trim();
            const a = parseInt(document.getElementById('exp-amt').value);
            if(!n || isNaN(a) || a <= 0) {
                console.error('è«‹è¼¸å…¥æœ‰æ•ˆçš„å“é …åç¨±å’Œæ—¥å¹£é‡‘é¡ã€‚'); 
                return;
            }
            
            const exps = getExps();
            exps.unshift({
                id: Date.now(), 
                n: n, 
                a: a, 
                img: tmpImg, 
                d: new Date().toLocaleDateString('zh-TW')
            });
            
            localStorage.setItem('trip_exps', JSON.stringify(exps));
            renderExps();
            toggleDrawer(false);
        }

        function renderExps() {
            const el = document.getElementById('expense-list');
            el.innerHTML = '';
            const r = parseFloat(document.getElementById('exchange-rate').value) || 0;
            const exps = getExps();
            let totalJPY = 0;
            let totalTWD = 0;
            
            if (exps.length === 0) {
                el.innerHTML = '<p class="text-center text-gray-400 py-10">å°šç„¡æ¶ˆè²»è¨˜éŒ„ã€‚é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ç¬¬ä¸€ç­†ï¼</p>';
                return;
            }

            exps.forEach(e => {
                const twd = Math.floor(e.a * r);
                totalJPY += e.a;
                totalTWD += twd;

                el.insertAdjacentHTML('beforeend', `
                    <div class="card p-3 flex justify-between items-center shadow-sm">
                        <div class="flex gap-3 items-center flex-1 min-w-0">
                            ${e.img ? 
                                `<div class="w-10 h-10 rounded-lg bg-cover bg-center flex-shrink-0 cursor-pointer" style="background-image:url(${e.img})" onclick="winOpen('${e.img}')" title="é»æ“Šçœ‹å¤§åœ–"></div>` : 
                                `<div class="w-10 h-10 rounded-lg bg-jp-light flex items-center justify-center text-gray-400 flex-shrink-0"><i class="fas fa-receipt"></i></div>`
                            }
                            <div class="truncate min-w-0">
                                <div class="font-bold text-sm truncate">${e.n}</div>
                                <div class="text-[10px] text-gray-400 font-num">${e.d}</div>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0 ml-3">
                            <div class="font-bold text-sm font-num text-jp-text">Â¥${e.a.toLocaleString('ja-JP')}</div>
                            <div class="text-xs font-num text-jp-sub">TWD$${twd.toLocaleString('zh-TW')}</div>
                            <button onclick="delExp(${e.id})" class="text-xs text-red-300 hover:text-red-500 mt-1"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `);
            });
            
            // Add Total Summary Card
            el.insertAdjacentHTML('afterbegin', `
                <div class="card p-4 bg-jp-accent text-white mb-4 shadow-xl">
                    <div class="flex justify-between items-center">
                        <span class="text-sm">ç´¯ç©ç¸½èŠ±è²»</span>
                        <span class="text-2xl font-bold font-num">Â¥${totalJPY.toLocaleString('ja-JP')}</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-xs">é ä¼°å°å¹£ç¸½æ”¯å‡º</span>
                        <span class="text-lg font-num">TWD$${totalTWD.toLocaleString('zh-TW')}</span>
                    </div>
                </div>
            `);
        }
        
        function delExp(id) { 
            console.warn('ç”¨æˆ¶è«‹æ±‚åˆªé™¤æ¶ˆè²»è¨˜éŒ„ï¼ŒID:', id);
            localStorage.setItem('trip_exps', JSON.stringify(getExps().filter(e=>e.id!==id))); 
            renderExps(); 
        }

        function clearExpHistory() {
             console.warn('ç”¨æˆ¶è«‹æ±‚æ¸…é™¤æ‰€æœ‰æ¶ˆè²»è¨˜éŒ„');
             localStorage.removeItem('trip_exps'); 
             renderExps(); 
        }

        function winOpen(u){ 
            const w=window.open("","_blank","width=600,height=400,resizable=yes,scrollbars=yes"); 
            w.document.write(`<body style="margin:0; background:#fcfcf5;"><img src="${u}" style="width:100%; height:auto; display:block;"></body>`); 
            w.document.close();
        }

        // 3. LISTS Logic
        
        // --- Packing List ---
        function getPack(){ 
            const defaultList = [
                {t:'è­·ç…§',c:false}, {t:'ç¶²å¡/eSIM',c:false}, {t:'å……é›»ç·š/è½‰æ¥é ­',c:false}, 
                {t:'éŒ¢åŒ…/æ—¥å¹£',c:false}, {t:'è¡Œå‹•é›»æº',c:false}, {t:'è–„å¤–å¥—/åœå·¾',c:false}
            ];
            return JSON.parse(localStorage.getItem('trip_pack')||JSON.stringify(defaultList)); 
        }
        function renderPack(){
            const c = document.getElementById('packing-container'); c.innerHTML='';
            getPack().forEach((i,x)=>{
                c.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center justify-between p-3 border-b border-jp-light hover:bg-jp-light/50 rounded-md" onclick="togPack(${x})">
                        <div class="flex items-center gap-3 cursor-pointer">
                            <div class="w-6 h-6 rounded-full border-2 ${i.c?'bg-jp-sub border-jp-sub':'border-gray-300'} flex items-center justify-center transition-colors flex-shrink-0">
                                ${i.c?'<i class="fas fa-check text-white text-xs"></i>':''}
                            </div>
                            <span class="${i.c?'text-gray-400 line-through':'text-jp-text'}">${i.t}</span>
                        </div>
                        <button onclick="event.stopPropagation();delPack(${x})" class="text-gray-300 hover:text-red-400 p-1"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `);
            });
        }
        function togPack(x){ 
            const l=getPack(); 
            l[x].c=!l[x].c; 
            localStorage.setItem('trip_pack',JSON.stringify(l)); 
            renderPack(); 
        }
        function addPack(){ 
            const input = document.getElementById('new-pack');
            const v=input.value.trim(); 
            if(v){ 
                const l=getPack(); 
                l.push({t:v,c:false}); 
                localStorage.setItem('trip_pack',JSON.stringify(l)); 
                input.value=''; 
                renderPack(); 
            }
        }
        function delPack(x){ 
            const l=getPack(); 
            l.splice(x,1); 
            localStorage.setItem('trip_pack',JSON.stringify(l)); 
            renderPack(); 
        }

        // --- Memo ---
        function switchList(t) {
            document.getElementById('view-packing').className = t==='packing'?'block':'hidden';
            document.getElementById('view-memo').className = t==='memo'?'block':'hidden';
            
            document.getElementById('tab-packing').className = t==='packing'?"flex-1 py-3 bg-jp-accent/10 text-jp-accent font-bold text-sm border-b-2 border-jp-accent transition-all":"flex-1 py-3 text-gray-400 text-sm transition-all";
            document.getElementById('tab-memo').className = t==='memo'?"flex-1 py-3 bg-jp-accent/10 text-jp-accent font-bold text-sm border-b-2 border-jp-accent transition-all":"flex-1 py-3 text-gray-400 text-sm transition-all";
        }
        
        function getMemo(){ return JSON.parse(localStorage.getItem('trip_memo')||'[]'); }
        function renderMemo(){
            const c=document.getElementById('memo-container'); c.innerHTML='';
            getMemo().forEach(m=>{
                // Auto-link recognition
                let t = m.t.replace(/(http[s]?:\/\/[^\s]+)/g, (url) => {
                    return `<a href="${url}" target="_blank" class="text-blue-600 underline hover:text-blue-800 break-words">${url.length > 30 ? url.substring(0, 30) + '...' : url} <i class="fas fa-external-link-alt text-[10px]"></i></a>`;
                });
                c.insertAdjacentHTML('beforeend', `
                    <div class="bg-jp-light p-3 text-sm rounded-lg relative group border-l-4 border-jp-sub shadow-sm">
                        <p class="whitespace-pre-wrap text-gray-700">${t}</p>
                        <button onclick="delMemo(${m.id})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-1 transition-colors"><i class="fas fa-times-circle"></i></button>
                    </div>
                `);
            });
        }
        function addMemo(){ 
            const input = document.getElementById('new-memo');
            const v = input.value.trim(); 
            if(v){ 
                const l=getMemo(); 
                l.unshift({id:Date.now(),t:v}); 
                localStorage.setItem('trip_memo',JSON.stringify(l)); 
                input.value=''; 
                renderMemo(); 
            }
        }
        function delMemo(id){ 
            localStorage.setItem('trip_memo',JSON.stringify(getMemo().filter(m=>m.id!==id))); 
            renderMemo(); 
        }

        // --- Init & Splash ---
        window.onload = function() {
            // CHANGE 1: Inject daily weather bars
            document.getElementById('weather-day-1').innerHTML = getWeatherBarHtml(0);
            document.getElementById('weather-day-2').innerHTML = getWeatherBarHtml(1);
            document.getElementById('weather-day-3').innerHTML = getWeatherBarHtml(2);
            document.getElementById('weather-day-4').innerHTML = getWeatherBarHtml(3);

            // CHANGE 3: Render POI Quick Links
            renderPoiQuickLinks();

            // Check for initial hash and navigate if available
            const initialHash = window.location.hash.substring(1);
            if (initialHash && ['plan', 'guide', 'util', 'lists'].includes(initialHash)) {
                nav(initialHash);
            } else {
                nav('plan'); // Default to plan
                switchPlanPage('overview'); // Default to overview sub-page
            }

            renderExps(); 
            renderPack(); 
            renderMemo();
            
            // Remove splash after delay
            setTimeout(() => {
                document.getElementById('splash-screen').classList.add('fade-out');
                setTimeout(() => document.getElementById('splash-screen').style.display='none', 500);
            }, 800);
        }
    </script>
</body>
</html>